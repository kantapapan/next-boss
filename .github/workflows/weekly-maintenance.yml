name: ğŸ”§ Weekly Maintenance

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ã®åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  # ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯
  dependency-check:
    name: ğŸ“¦ Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'next-boss/package-lock.json'
          
      - name: ğŸ” Check for outdated packages
        run: |
          echo "# ğŸ“¦ Dependency Status Report" > dependency-report.md
          echo "" >> dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          
          cd next-boss
          
          # ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
          echo "## ğŸ  Main Project Dependencies" >> ../dependency-report.md
          echo "" >> ../dependency-report.md
          echo "```" >> ../dependency-report.md
          npm outdated || true >> ../dependency-report.md
          echo "```" >> ../dependency-report.md
          echo "" >> ../dependency-report.md
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
          echo "## ğŸ”’ Security Audit" >> ../dependency-report.md
          echo "" >> ../dependency-report.md
          echo "```" >> ../dependency-report.md
          npm audit --audit-level=moderate || true >> ../dependency-report.md
          echo "```" >> ../dependency-report.md
          
      - name: ğŸ” Check example dependencies
        run: |
          echo "" >> dependency-report.md
          echo "## ğŸ“š Example Dependencies" >> dependency-report.md
          echo "" >> dependency-report.md
          
          for example_dir in next-boss/examples/*/; do
            if [ -f "$example_dir/package.json" ]; then
              example_name=$(basename "$example_dir")
              echo "### $example_name" >> dependency-report.md
              echo "" >> dependency-report.md
              echo "```" >> dependency-report.md
              cd "$example_dir"
              npm outdated || true >> ../../../dependency-report.md
              cd - > /dev/null
              echo "```" >> dependency-report.md
              echo "" >> dependency-report.md
            fi
          done
          
      - name: ğŸ“¤ Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md
          retention-days: 30

  # ãƒªãƒ³ã‚¯ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
  link-check:
    name: ğŸ”— Link Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”— Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/workflows/link-check-config.json'
          folder-path: 'next-boss/docs, .'
          file-path: 'README.md'
        continue-on-error: true
        
      - name: ğŸ“Š Generate link report
        run: |
          echo "# ğŸ”— Link Health Report" > link-report.md
          echo "" >> link-report.md
          echo "Generated on: $(date)" >> link-report.md
          echo "" >> link-report.md
          
          # å†…éƒ¨ãƒªãƒ³ã‚¯ã®ãƒã‚§ãƒƒã‚¯
          echo "## ğŸ“ Internal Links" >> link-report.md
          echo "" >> link-report.md
          
          # README.mdã®å­¦ç¿’ä¾‹ãƒªãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          if grep -n "next-boss/examples" README.md; then
            echo "âœ… Learning example links found in README" >> link-report.md
          else
            echo "âŒ Learning example links not found in README" >> link-report.md
          fi
          
          # å„å­¦ç¿’ä¾‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
          echo "" >> link-report.md
          echo "## ğŸ“š Learning Examples" >> link-report.md
          echo "" >> link-report.md
          
          for i in {01..09}; do
            if [ -d "next-boss/examples/${i}-"* ]; then
              example_name=$(ls -d next-boss/examples/${i}-* | head -1 | xargs basename)
              echo "- âœ… $example_name" >> link-report.md
            else
              echo "- âŒ Example ${i} missing" >> link-report.md
            fi
          done
          
      - name: ğŸ“¤ Upload link report
        uses: actions/upload-artifact@v4
        with:
          name: link-report
          path: link-report.md
          retention-days: 30

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆã®ç”Ÿæˆ
  project-stats:
    name: ğŸ“Š Project Statistics
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Generate project statistics
        run: |
          echo "# ğŸ“Š Next Boss Project Statistics" > project-stats.md
          echo "" >> project-stats.md
          echo "Generated on: $(date)" >> project-stats.md
          echo "" >> project-stats.md
          
          # åŸºæœ¬çµ±è¨ˆ
          echo "## ğŸ“ˆ Basic Statistics" >> project-stats.md
          echo "" >> project-stats.md
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          total_files=$(find . -type f -not -path "./node_modules/*" -not -path "./.git/*" | wc -l)
          echo "- **Total Files**: $total_files" >> project-stats.md
          
          # TypeScript/JavaScript ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          ts_files=$(find . -name "*.ts" -o -name "*.tsx" -not -path "./node_modules/*" | wc -l)
          js_files=$(find . -name "*.js" -o -name "*.jsx" -not -path "./node_modules/*" | wc -l)
          echo "- **TypeScript Files**: $ts_files" >> project-stats.md
          echo "- **JavaScript Files**: $js_files" >> project-stats.md
          
          # Markdown ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          md_files=$(find . -name "*.md" -not -path "./node_modules/*" | wc -l)
          echo "- **Documentation Files**: $md_files" >> project-stats.md
          
          # å­¦ç¿’ä¾‹ã®æ•°
          example_count=$(find next-boss/examples -maxdepth 1 -type d | grep -E '[0-9]{2}-' | wc -l)
          echo "- **Learning Examples**: $example_count" >> project-stats.md
          
          # ã‚³ãƒ¼ãƒ‰è¡Œæ•°
          echo "" >> project-stats.md
          echo "## ğŸ“ Code Lines" >> project-stats.md
          echo "" >> project-stats.md
          echo "```" >> project-stats.md
          find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | \
            grep -v node_modules | \
            xargs wc -l | \
            tail -1 >> project-stats.md
          echo "```" >> project-stats.md
          
          # æœ€è¿‘ã®æ´»å‹•
          echo "" >> project-stats.md
          echo "## ğŸ•’ Recent Activity" >> project-stats.md
          echo "" >> project-stats.md
          echo "```" >> project-stats.md
          git log --oneline -10 >> project-stats.md
          echo "```" >> project-stats.md
          
          # è²¢çŒ®è€…çµ±è¨ˆ
          echo "" >> project-stats.md
          echo "## ğŸ‘¥ Contributors" >> project-stats.md
          echo "" >> project-stats.md
          echo "```" >> project-stats.md
          git shortlog -sn >> project-stats.md
          echo "```" >> project-stats.md
          
      - name: ğŸ“¤ Upload project statistics
        uses: actions/upload-artifact@v4
        with:
          name: project-stats
          path: project-stats.md
          retention-days: 90

  # å­¦ç¿’é€²æ—ã®æ›´æ–°
  progress-update:
    name: ğŸ“ˆ Progress Update
    runs-on: ubuntu-latest
    needs: [dependency-check, link-check, project-stats]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“ˆ Calculate current progress
        run: |
          echo "# ğŸ“ˆ Weekly Progress Update" > progress-update.md
          echo "" >> progress-update.md
          echo "Generated on: $(date)" >> progress-update.md
          echo "" >> progress-update.md
          
          # å®Œäº†ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¨ˆç®—
          completed_sections=11
          total_sections=15
          progress=$((completed_sections * 100 / total_sections))
          
          echo "## ğŸ¯ Current Status" >> progress-update.md
          echo "" >> progress-update.md
          echo "- **Overall Progress**: ${progress}% (${completed_sections}/${total_sections})" >> progress-update.md
          echo "- **Learning Examples**: $(find next-boss/examples -maxdepth 1 -type d | grep -E '[0-9]{2}-' | wc -l) completed" >> progress-update.md
          echo "- **Documentation Files**: $(find next-boss/docs -name "*.md" | wc -l) completed" >> progress-update.md
          echo "" >> progress-update.md
          
          echo "## ğŸ“‹ Remaining Tasks" >> progress-update.md
          echo "" >> progress-update.md
          echo "- [ ] ğŸ’ª å®Ÿè·µèª²é¡Œé›† (exercise-01ã€œ06)" >> progress-update.md
          echo "- [ ] ğŸ“Š å­¦ç¿’é€²æ—ç®¡ç†æ©Ÿèƒ½" >> progress-update.md
          echo "- [ ] ğŸ¯ å­¦ç¿’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" >> progress-update.md
          echo "- [ ] ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰" >> progress-update.md
          echo "" >> progress-update.md
          
          echo "## ğŸ† Recent Achievements" >> progress-update.md
          echo "" >> progress-update.md
          echo "- âœ… å®Œå…¨ãªãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹" >> progress-update.md
          echo "- âœ… API Routeså®Ÿè£…" >> progress-update.md
          echo "- âœ… ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³" >> progress-update.md
          echo "- âœ… ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°æ‰‹æ³•" >> progress-update.md
          
      - name: ğŸ“¤ Upload progress update
        uses: actions/upload-artifact@v4
        with:
          name: progress-update
          path: progress-update.md
          retention-days: 90

  # ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†é€šçŸ¥
  maintenance-complete:
    name: ğŸ‰ Maintenance Complete
    runs-on: ubuntu-latest
    needs: [dependency-check, link-check, project-stats, progress-update]
    if: always()
    
    steps:
      - name: ğŸ‰ Maintenance summary
        run: |
          echo "ğŸ”§ Weekly maintenance completed!"
          echo ""
          echo "ğŸ“Š Reports generated:"
          echo "- ğŸ“¦ Dependency status"
          echo "- ğŸ”— Link health check"
          echo "- ğŸ“Š Project statistics"
          echo "- ğŸ“ˆ Progress update"
          echo ""
          echo "ğŸš€ Next Boss is healthy and ready for learning!"
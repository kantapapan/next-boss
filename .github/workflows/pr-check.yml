name: ğŸ” Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # PRæƒ…å ±ã®åˆ†æ
  pr-analysis:
    name: ğŸ“‹ PR Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“Š Analyze changes
        run: |
          echo "# ğŸ” Pull Request Analysis" >> pr-analysis.md
          echo "" >> pr-analysis.md
          echo "**PR Title**: ${{ github.event.pull_request.title }}" >> pr-analysis.md
          echo "**Author**: @${{ github.event.pull_request.user.login }}" >> pr-analysis.md
          echo "**Branch**: ${{ github.head_ref }}" >> pr-analysis.md
          echo "" >> pr-analysis.md
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
          echo "## ğŸ“ Changed Files" >> pr-analysis.md
          echo "" >> pr-analysis.md
          
          # å­¦ç¿’ä¾‹ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          if git diff --name-only origin/main...HEAD | grep -q "examples/"; then
            echo "ğŸ“š **Learning Examples Modified**" >> pr-analysis.md
            git diff --name-only origin/main...HEAD | grep "examples/" | sed 's/^/- /' >> pr-analysis.md
            echo "" >> pr-analysis.md
          fi
          
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          if git diff --name-only origin/main...HEAD | grep -q "docs/\|README.md"; then
            echo "ğŸ“– **Documentation Modified**" >> pr-analysis.md
            git diff --name-only origin/main...HEAD | grep -E "docs/|README.md" | sed 's/^/- /' >> pr-analysis.md
            echo "" >> pr-analysis.md
          fi
          
          # GitHub Actionsã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          if git diff --name-only origin/main...HEAD | grep -q ".github/workflows/"; then
            echo "âš™ï¸ **GitHub Actions Modified**" >> pr-analysis.md
            git diff --name-only origin/main...HEAD | grep ".github/workflows/" | sed 's/^/- /' >> pr-analysis.md
            echo "" >> pr-analysis.md
          fi
          
          # å¤‰æ›´çµ±è¨ˆ
          echo "## ğŸ“ˆ Change Statistics" >> pr-analysis.md
          echo "" >> pr-analysis.md
          echo "```" >> pr-analysis.md
          git diff --stat origin/main...HEAD >> pr-analysis.md
          echo "```" >> pr-analysis.md
          
      - name: ğŸ“¤ Upload analysis
        uses: actions/upload-artifact@v4
        with:
          name: pr-analysis
          path: pr-analysis.md

  # å­¦ç¿’ä¾‹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  example-consistency:
    name: ğŸ§ª Example Consistency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Check example structure
        run: |
          echo "ğŸ” Checking example directory structure..."
          
          # å„å­¦ç¿’ä¾‹ã®å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          for example_dir in next-boss/examples/*/; do
            if [ -d "$example_dir" ]; then
              example_name=$(basename "$example_dir")
              echo "Checking $example_name..."
              
              # package.jsonã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
              if [ -f "$example_dir/package.json" ]; then
                echo "  âœ… package.json exists"
              else
                echo "  âš ï¸ package.json missing"
              fi
              
              # READMEã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
              if [ -f "$example_dir/README.md" ]; then
                echo "  âœ… README.md exists"
              else
                echo "  âš ï¸ README.md missing"
              fi
              
              # Next.jsè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
              if [ -f "$example_dir/next.config.ts" ] || [ -f "$example_dir/next.config.js" ]; then
                echo "  âœ… Next.js config exists"
              else
                echo "  âš ï¸ Next.js config missing"
              fi
              
              # TypeScriptè¨­å®šã®ãƒã‚§ãƒƒã‚¯
              if [ -f "$example_dir/tsconfig.json" ]; then
                echo "  âœ… TypeScript config exists"
              else
                echo "  âš ï¸ TypeScript config missing"
              fi
              
              echo ""
            fi
          done

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆPRå°‚ç”¨ï¼‰
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Check for sensitive information
        run: |
          echo "ğŸ” Scanning for sensitive information..."
          
          # APIã‚­ãƒ¼ã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¤œç´¢
          if grep -r -i -E "(api[_-]?key|secret|password|token)" --include="*.ts" --include="*.js" --include="*.json" . | grep -v "example\|sample\|test\|docs"; then
            echo "âš ï¸ Potential sensitive information found!"
            echo "Please review the above matches."
          else
            echo "âœ… No sensitive information detected"
          fi
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
          if find . -name ".env*" -not -path "./node_modules/*" -not -name ".env.example" -not -name ".env.local.example"; then
            echo "âš ï¸ Environment files found!"
            echo "Make sure they are properly gitignored."
          else
            echo "âœ… No environment files found"
          fi
          
          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸURLã®æ¤œç´¢
          if grep -r -E "https?://[^/]*\.(com|org|net|io)" --include="*.ts" --include="*.js" . | grep -v "example\|placeholder\|docs\|README" | head -5; then
            echo "âš ï¸ Hardcoded URLs found - please review"
          else
            echo "âœ… No suspicious hardcoded URLs found"
          fi

  # ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ”¯æ´
  code-review-helper:
    name: ğŸ‘€ Code Review Helper
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ” Generate review checklist
        run: |
          echo "# ğŸ‘€ Code Review Checklist" > review-checklist.md
          echo "" >> review-checklist.md
          echo "## ğŸ“‹ General Checks" >> review-checklist.md
          echo "" >> review-checklist.md
          echo "- [ ] Code follows TypeScript best practices" >> review-checklist.md
          echo "- [ ] No console.log statements in production code" >> review-checklist.md
          echo "- [ ] Error handling is implemented properly" >> review-checklist.md
          echo "- [ ] Comments are clear and helpful" >> review-checklist.md
          echo "- [ ] No hardcoded values (use constants/config)" >> review-checklist.md
          echo "" >> review-checklist.md
          
          # Next.jsç‰¹æœ‰ã®ãƒã‚§ãƒƒã‚¯
          if git diff --name-only origin/main...HEAD | grep -E "\.(tsx?|jsx?)$"; then
            echo "## âš›ï¸ Next.js/React Checks" >> review-checklist.md
            echo "" >> review-checklist.md
            echo "- [ ] Components are properly typed" >> review-checklist.md
            echo "- [ ] Server/Client Components are used appropriately" >> review-checklist.md
            echo "- [ ] No useEffect in Server Components" >> review-checklist.md
            echo "- [ ] Proper error boundaries are implemented" >> review-checklist.md
            echo "- [ ] Accessibility attributes are included" >> review-checklist.md
            echo "" >> review-checklist.md
          fi
          
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ›´ã®ãƒã‚§ãƒƒã‚¯
          if git diff --name-only origin/main...HEAD | grep -E "\.md$"; then
            echo "## ğŸ“– Documentation Checks" >> review-checklist.md
            echo "" >> review-checklist.md
            echo "- [ ] Links are working correctly" >> review-checklist.md
            echo "- [ ] Code examples are accurate" >> review-checklist.md
            echo "- [ ] Japanese text is natural and clear" >> review-checklist.md
            echo "- [ ] Screenshots/diagrams are up to date" >> review-checklist.md
            echo "" >> review-checklist.md
          fi
          
          echo "## ğŸ¯ Learning Content Checks" >> review-checklist.md
          echo "" >> review-checklist.md
          echo "- [ ] Examples are beginner-friendly" >> review-checklist.md
          echo "- [ ] Step-by-step instructions are clear" >> review-checklist.md
          echo "- [ ] Code is well-commented for learning" >> review-checklist.md
          echo "- [ ] Difficulty progression is appropriate" >> review-checklist.md
          
      - name: ğŸ“¤ Upload review checklist
        uses: actions/upload-artifact@v4
        with:
          name: review-checklist
          path: review-checklist.md

  # PRæˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  pr-success:
    name: ğŸ‰ PR Checks Complete
    runs-on: ubuntu-latest
    needs: [pr-analysis, example-consistency, security-check, code-review-helper]
    if: success()
    
    steps:
      - name: ğŸ‰ Success message
        run: |
          echo "ğŸ‰ All PR checks completed successfully!"
          echo ""
          echo "âœ… PR Analysis: PASSED"
          echo "âœ… Example Consistency: PASSED"
          echo "âœ… Security Check: PASSED"
          echo "âœ… Code Review Helper: READY"
          echo ""
          echo "ğŸš€ This PR is ready for human review!"
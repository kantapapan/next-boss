name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'next-boss/package-lock.json'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd next-boss
          npm ci
          
      - name: ğŸ” ESLint check
        run: |
          cd next-boss
          npm run lint
          
      - name: ğŸ—ï¸ TypeScript check
        run: |
          cd next-boss
          npx tsc --noEmit
          
      - name: ğŸ¨ Prettier check
        run: |
          cd next-boss
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,md}"
        continue-on-error: true

  # è¤‡æ•°ã®å­¦ç¿’ä¾‹ã‚’ä¸¦åˆ—ã§ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-examples:
    name: ğŸ—ï¸ Build Examples
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        example: [
          '01-basic-setup',
          '02-pages-and-routing', 
          '03-components-and-props',
          '04-server-client-components',
          '05-data-fetching',
          '06-styling-methods',
          '07-forms-and-validation',
          '08-api-routes',
          '09-full-app-example'
        ]
      fail-fast: false
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies for ${{ matrix.example }}
        run: |
          cd next-boss/examples/${{ matrix.example }}
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping..."
          fi
          
      - name: ğŸ—ï¸ Build ${{ matrix.example }}
        run: |
          cd next-boss/examples/${{ matrix.example }}
          if [ -f package.json ]; then
            npm run build
          else
            echo "No build script found, skipping..."
          fi
          
      - name: ğŸ§ª Test ${{ matrix.example }}
        run: |
          cd next-boss/examples/${{ matrix.example }}
          if [ -f package.json ] && npm run | grep -q "test"; then
            npm test
          else
            echo "No test script found, skipping..."
          fi
        continue-on-error: true

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'next-boss/package-lock.json'
          
      - name: ğŸ”§ Install dependencies
        run: |
          cd next-boss
          npm ci
          
      - name: ğŸ” Run npm audit
        run: |
          cd next-boss
          npm audit --audit-level=moderate
        continue-on-error: true
        
      - name: ğŸ”’ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  docs-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Check README links
        run: |
          # README.mdã®ãƒªãƒ³ã‚¯ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
          if grep -q "next-boss/examples" README.md; then
            echo "âœ… README links look correct"
          else
            echo "âŒ README links may be incorrect"
            exit 1
          fi
          
      - name: ğŸ“‹ Check example directories
        run: |
          # å„å­¦ç¿’ä¾‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          examples=(
            "01-basic-setup"
            "02-pages-and-routing"
            "03-components-and-props"
            "04-server-client-components"
            "05-data-fetching"
            "06-styling-methods"
            "07-forms-and-validation"
            "08-api-routes"
            "09-full-app-example"
          )
          
          for example in "${examples[@]}"; do
            if [ -d "next-boss/examples/$example" ]; then
              echo "âœ… $example directory exists"
            else
              echo "âŒ $example directory missing"
              exit 1
            fi
          done
          
      - name: ğŸ“– Check documentation files
        run: |
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          docs=(
            "01-getting-started.md"
            "02-routing.md"
            "03-components.md"
            "04-data-fetching.md"
            "05-styling.md"
            "06-api-routes.md"
          )
          
          for doc in "${docs[@]}"; do
            if [ -f "next-boss/docs/$doc" ]; then
              echo "âœ… $doc exists"
            else
              echo "âŒ $doc missing"
              exit 1
            fi
          done

  # å­¦ç¿’é€²æ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  progress-report:
    name: ğŸ“Š Progress Report
    runs-on: ubuntu-latest
    needs: [build-examples, docs-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Generate progress report
        run: |
          echo "# ğŸš€ Next Boss Progress Report" > progress-report.md
          echo "" >> progress-report.md
          echo "Generated on: $(date)" >> progress-report.md
          echo "" >> progress-report.md
          
          # å­¦ç¿’ä¾‹ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          example_count=$(find next-boss/examples -maxdepth 1 -type d | grep -E '[0-9]{2}-' | wc -l)
          echo "ğŸ“š **Learning Examples**: $example_count completed" >> progress-report.md
          
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          doc_count=$(find next-boss/docs -name "*.md" | wc -l)
          echo "ğŸ“– **Documentation Files**: $doc_count completed" >> progress-report.md
          
          # é€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆ15ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸­ï¼‰
          total_sections=15
          completed_sections=11
          progress=$((completed_sections * 100 / total_sections))
          echo "ğŸ“ˆ **Overall Progress**: ${progress}% (${completed_sections}/${total_sections})" >> progress-report.md
          
          echo "" >> progress-report.md
          echo "## ğŸ¯ Completed Sections" >> progress-report.md
          echo "" >> progress-report.md
          
          for dir in next-boss/examples/*/; do
            if [ -d "$dir" ]; then
              example_name=$(basename "$dir")
              echo "- âœ… $example_name" >> progress-report.md
            fi
          done
          
      - name: ğŸ“¤ Upload progress report
        uses: actions/upload-artifact@v4
        with:
          name: progress-report
          path: progress-report.md
          retention-days: 30

  # æˆåŠŸæ™‚ã®é€šçŸ¥
  success-notification:
    name: ğŸ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [build-examples, security-scan, docs-check]
    if: success()
    
    steps:
      - name: ğŸ‰ Success message
        run: |
          echo "ğŸ‰ All checks passed successfully!"
          echo "âœ… Code quality: PASSED"
          echo "âœ… Build examples: PASSED"
          echo "âœ… Security scan: PASSED"
          echo "âœ… Documentation: PASSED"
          echo ""
          echo "ğŸš€ Ready for deployment!"